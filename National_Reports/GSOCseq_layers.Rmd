---
output: bookdown::pdf_book
header-includes:
    - \usepackage{titling}
    - \usepackage{pdfpages}
    - \usepackage{fancyhdr}
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{subfig}
    - \usepackage{array}
    - \usepackage{multirow}
    - \usepackage{wrapfig}
    - \usepackage{float}
    - \usepackage{colortbl}
    - \usepackage{pdflscape}
    - \usepackage{tabu}
    - \usepackage{threeparttable}
    - \usepackage{threeparttablex}
    - \usepackage[normalem]{ulem}
    - \usepackage{makecell}
    - \usepackage{xcolor}
    - \DeclareUnicodeCharacter{2212}{\textendash}
fig_caption: TRUE
documentclass: book
classoption: oneside
papersize: b5
fontsize: 10pt

---


```{r set-options, echo=FALSE,warning=FALSE, message=FALSE}
#User defined variables

knitr::opts_chunk$set(cache=F,fig.pos = 'H' ,echo=FALSE, cache=FALSE, warning=FALSE, message=FALSE)

## RSR and AbsDiff breaks
my.brks_rsr=c(-Inf, seq(0, 0.5, 0.1), Inf)
my.brks_abs=c(-Inf, seq(-10, 10,1), Inf)

## Folder containing GSOCseq 
gseq_folder <- 'C:/Users/hp/Documents/FAO/GSOCseq/GSOCseq_Results_data/GSOCseq_V1'
## Folder to the UN 2020 mao
un_folder <-'C:/Users/hp/Documents/FAO/data/un_maps/Official UN Map/UN_Map_v2020/UNmap0_shp/'

cols <-c(SSM1="grey28",SSM2="goldenrod1",SSM3="palegreen3")


#Load libraries
library(raster)
library(rgdal)
library(rasterVis)
library(RColorBrewer)
library(viridis)
library(stringr)
library(ggplot2)
library(data.table)
library(classInt)
library(plotly)
library(googlesheets4)
library(kableExtra)


## Country specific results
c_data <- fread("C:/Users/hp/Documents/GitHub/GSOCseq-Technical-Report/output_data/World_map_All_GSOCseq_stats_allscenarios.csv")
```

```{r echo=FALSE}
#Country specific Metadata
#Data to be imported from google sheet
sheet_url <- "https://docs.google.com/spreadsheets/d/1B9qukBJehe7p0T4TkwR8A4tUMLs8LkP5m6nlM9ae4ZM/edit#gid=2110860500"
##sheet of interest for the map
gs4_deauth()
sheet <- "Master"
gsheet <- read_sheet(sheet_url, sheet =sheet)
gsheet <- as.data.table(gsheet)
gsheet$date <- substr(gsheet$Timestamp, 1, 10)
gsheet$date <- as.Date(gsheet$date)
gsheet <-gsheet[, c("ISO", "Country") := tstrsplit(Country, "; ", fixed=TRUE)]
gsheet[, "Country"] <- NULL
#Select unique latest observation
gsheet <-unique(gsheet[order(date)], by="ISO", fromLast=TRUE)
submitted <- unique(gsheet$ISO)
blanks <- c("AUS","AUT","BEL",
            "LVA","NLD","NZL","NOR", "ITA", "ISR")

status <- rbind(data.frame(ISO=submitted, status=rep("National Submission", length(submitted))),
               data.frame(ISO=blanks, status=rep("Blank", length(blanks))))
gap <-c("UKR","BRA","IDN","KOR")
status$status <- ifelse(status$ISO %in% gap, 'Gap-filled',status$status)
status<-  merge(countries,status, by='ISO', all.x=T) 
status$status <- ifelse(is.na(status$status), 'Gap-filled',status$status)

# Country specific mitigation potential
gseq <-fread("C:/Users/hp/Documents/GitHub/GSOCseq-Technical-Report/output_data/World_map_All_GSOCseq_stats_allscenarios.csv")
faost <- fread('C:/Users/hp/Documents/GitHub/GSOCseq-Technical-Report/output_data/static/FAOSTAT_data_9-22-2021.csv')
ISO <-fread('C:/Users/hp/Documents/GitHub/GSOCseq-Technical-Report/output_data/static/FAO_area_ISO.csv')

colnames(faost)[3] <-'FAOSTAT'
faost <- merge(faost[,.(FAOSTAT, Value)], ISO[,.(FAOSTAT,ISO3)], by='FAOSTAT', all.x=T)


faost <- faost[complete.cases(faost),]

gseq$zone <-as.factor(gseq$zone)
ISO <- fread('C:/Users/hp/Documents/GitHub/GSOCseq-Technical-Report/output_data/static/metadata_ISO.csv')
colnames(ISO)[2] <-'zone'
colnames(ISO)[3] <-'ISO3'
ISO$zone <- as.character(ISO$zone)

gseq <- merge(gseq, ISO[,.(zone, ISO3)],by='zone', all.x=T)
  

  data <- gseq[ISO3 == i,]
  data <- data[!duplicated(data),]
  fao <- faost[ISO3 == i,]
  ############Figure 3 Potential Mitigation ###########################################################
  ## Carbon ton to CO2 conversion
  CO2conv <- 3.67
  
  
  colnames(data)[3] <- "Layer"
  data$Layer <- as.factor(data$Layer)
  
  #Convert SOC in Mt to CO2 Mt
  totssm1 <-round(as.numeric(data[Layer== "RSR_SSM1",4]),3)*CO2conv/1000000
  totssm2 <-round(as.numeric(data[Layer== "RSR_SSM2",4]),3)*CO2conv/1000000
  totssm3 <-round(as.numeric(data[Layer== "RSR_SSM3",4]),3)*CO2conv/1000000
  
  
  
  totagrem <- round(sum(fao$Value)/1000,2)
  
  
  # Estimate mitigation potential
  SSM1 <-round(((totssm1/totagrem) *100),2)
  SSM2 <-round(((totssm2/totagrem) *100),2)
  SSM3 <-round(((totssm3/totagrem) *100),2)
  
  
  
  data <-data.frame(Total_Agricultural_Emissions =c(totagrem, totagrem, totagrem),
                    Scenario = c("SSM1", "SSM2", "SSM3"),
                    C_sequestered =c(totssm1,totssm2, totssm3),
                    Mitigation_share =c(SSM1,SSM2,SSM3))

```
## Editorial board{-}

Guillermo Peralta (GSP Secretariat)    
Luciano Di Paolo (GSP Secretariat)    
Isabel Luotto (GSP Secretariat)  
Yusuf Yigini (GSP Secretariat)  




```{r echo=FALSE,fig.width=6,echo=FALSE,message=FALSE,warnin=FALSE,results="asis"}
if(status[status$ISO==i,'status']=='National Submission'){cat('## Authors{-}')
  cat("  \n","\n")
 temp <- gsheet[gsheet$ISO==i,]
 name <- temp$`National Expert(s) - Author Name and Surname separated by a ";" (e.g. John Smith; Max Mustermann)`
 name <- unlist(str_split(name, pattern = ';'))
 name <- str_trim(name)
 name <- paste0(name, '  ')
 cat(name, sep ='\n')
  cat("  \n","\n")
  
  cat('## Data Holding Institution(s){-}')
  cat("  \n","\n")
  cat(temp$`Data-holding Institution(s)`)
  cat("  \n","\n")
  cat("  \n","\n")
  cat("  \n","\n")
  } 

```
  
    
      
      
***Cover design:*** Matteo Sala

\pagebreak

# GSOCseq: `r country` {-}
This document presents the most relevant outputs from the Global Soil Organic Carbon Sequestration Potential Map (GSOCseq) v.1.1 for `r country`. 
Table 1 summarizes the inputs used to generate the 29 GSOCseq output layers. The GSOCseq layers were created based on a spatialized version of the process-based Rothamsted Carbon Model (RothC), made available through the open-source R software. Soil Organic Carbon (SOC) sequestration potential in t C/ha/yr as well as SOC stocks in t C/ha were modeled over agricultural areas for 20 years into the future based on a Business as Usual (BAU) scenario and three Sustainable Soil Management (SSM) scenarios that vary in the degree of carbon input to the soil (SSM1= 5%; SSM2=10%;SSM3=20% Carbon Input increase over the BAU scenario). 
```{r, echo=FALSE,results='asis'}
if(status[status$ISO==i,'status']=='National Submission'){cat('The model was run over a 1km point grid for the GSOCseq target areas.')} else {cat('The model was run over a 5km point grid for the GSOCseq target areas. The output layers were subsequently downscaled to a 1km resolution using a weighted Generalized Additive Model (GAM) model following the approach described by Malone et al., (2012).')}
```


For more details on the methodology please refer to the GSOCseq Technical Specifications and Country Guidelines (http://www.fao.org/documents/card/en/c/cb0353en/).

Figure 1 shows the total additional Mt of C sequestered on a yearly basis under the under the three SSM scenarios compared to the BAU scenario for `r country`.
A summary of the development of total SOC stocks in Mt C and mean SOC values in t C ha^-1^ under the BAU and the three SSM scenarios (SSM1-3) for `r country` for the year 2040 is provided in Table 2. The Layer T0 was used to derive the total SOC stocks at simulation begin (T0=2020). Table 3 shows the differences in SOC stocks in Mt C under the various scenarios. Absolutes differences indicate differences between final SOC stocks at simulation end (2040) under four different soil management scenarios (SSM1-3 and BAU) and initial SOC stocks at the beginning of the simulation T0 (2020). Relative differences on the other hand indicate differences between final SOC stocks under the BAU scenario and the final SOC stocks under the three SSM (SSM1-3) scenarios. In other words relative differences indicate additional SOC stocks under the adoption of SSM practices compared to the BAU scenario. 
Figure 2 shows the the distribution of Relative Sequestration Rates (RSR) of SOC in t C ha^-1^ yr^-1^ in `r country`.  

Figure 3 Shows the distribution of absolute difference in SOC in t C ha^-1^ between the SOC stocks at simulation begin and under the BAU and SSM (SSM1-3) scenarios.
Figure 4 shows total RSR in Pg of CO2 yr^-1^ in relation to total yearly agricultural emissions derived from FAOSTAT (2019) according to the IPCC Fifth Assessment Report (AR5) for `r country`. The GSOCseq shows that the adoption of SSM practices could potentially lead a yearly mitigation of `r paste0(data[1,4],'-',data[3,4])` percent of total agricultural emissions in `r country`.


```{r, echo = FALSE}

if(status[status$ISO==i,'status']=='National Submission'){
 
  temp <- t(gsheet[gsheet$ISO ==i,8:11])
  
  kbl(temp,booktabs = T, format= 'latex', caption = 'National data sources used to generate national GSOCseq maps.') %>%
 kable_styling(font_size = 8, latex_options = c("HOLD_position"))
   
}else{
dt <- read.csv("data/Table_6.3.csv", sep = ";", fileEncoding = 'UTF-8-BOM')
kbl(dt,booktabs = T, format= 'latex', caption = 'Global data sources to generate national GSOCseq maps.') %>%
 kable_styling(font_size = 8, latex_options = c("HOLD_position", "scale_down")) }
```



```{r echo =FALSE}
#Cut GSOCseq RSR and absdiff
#Load global background map
map <- readOGR(paste0(un_folder,"BNDA_CTY.shp"),verbose=FALSE)

map <- map[map$ISO3CD == i,]

#datae difference
absdiffbau <- raster(paste0(gseq_folder,'/GSOCseq_AbsDiff_BAU_Map030.tif'))
absdiffbau <- crop(absdiffbau,map)
absdiffbau <- mask(absdiffbau,map)

absdiff2<- raster(paste0(gseq_folder,'/GSOCseq_AbsDiff_SSM2_Map030.tif'))
absdiff2 <- crop(absdiff2,map)
absdiff2 <- mask(absdiff2,map)

absdiff3<- raster(paste0(gseq_folder,'/GSOCseq_AbsDiff_SSM3_Map030.tif'))
absdiff3 <- crop(absdiff3,map)
absdiff3 <- mask(absdiff3,map)

absdiff1<- raster(paste0(gseq_folder,'/GSOCseq_AbsDiff_SSM1_Map30.tif'))
absdiff1 <- crop(absdiff1,map)
absdiff1 <- mask(absdiff1,map)

#T0
t0 <-raster(paste0(gseq_folder,'/GSOCseq_T0_Map030.tif'))
t0 <- crop(t0,map)
t0 <- mask(t0,map)

#Final SOC stocks
bau <-raster(paste0(gseq_folder,'/GSOCseq_finalSOC_BAU_Map030.tif'))
bau <- crop(bau,map)
bau <- mask(bau,map)

ssm1 <-raster(paste0(gseq_folder,'/GSOCseq_finalSOC_SSM1_Map030.tif'))
ssm1 <- crop(ssm1,map)
ssm1 <- mask(ssm1,map)

ssm2 <-raster(paste0(gseq_folder,'/GSOCseq_finalSOC_SSM2_Map030.tif'))
ssm2 <- crop(ssm2,map)
ssm2 <- mask(ssm2,map)

ssm3 <-raster(paste0(gseq_folder,'/GSOCseq_finalSOC_SSM3_Map030.tif'))
ssm3 <- crop(ssm3,map)
ssm3 <- mask(ssm3,map)


#Uncertainties 
#T0
t0_unc <-raster(paste0(gseq_folder,'/GSOCseq_T0_UncertaintyMap030.tif'))
t0_unc <- crop(t0_unc,map)
t0_unc <- mask(t0_unc,map)

#Final BAU
bau_unc <-raster(paste0(gseq_folder,'/GSOCseq_BAU_UncertaintyMap030.tif'))
bau_unc <- crop(bau_unc,map)
bau_unc <- mask(bau_unc,map)

#Final SSM
ssm_unc <-raster(paste0(gseq_folder,'/GSOCseq_SSM_UncertaintyMap030.tif'))
ssm_unc <- crop(ssm_unc,map)
ssm_unc <- mask(ssm_unc,map)




```


```{r}


 #T0
      t0_unc <- t0+ t0*(t0_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(t0, "mean")
      mean_un <-cellStats(t0_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      t0 <- t0*area(t0)*100
      t0_unc <- t0_unc*area(t0_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(t0, "sum")/1000000
      sum_un <-cellStats(t0_unc, "sum")/1000000-sum 
     
      
      stats <- data.frame(product ='t0',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)
      
 #Final BAU
      bau_unc <- bau+ bau*(bau_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(bau, "mean")
      mean_un <-cellStats(bau_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      bau <- bau*area(bau)*100
      bau_unc <- bau_unc*area(bau_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(bau, "sum")/1000000
      sum_un <-cellStats(bau_unc, "sum")/1000000 -sum 
     
      
      stats2 <- data.frame(product ='BAU',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)
 #Final SSM1
      ssm1_unc <- ssm1+ ssm1*(ssm_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(ssm1, "mean")
      mean_un <-cellStats(ssm1_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      ssm1 <- ssm1*area(ssm1)*100
      ssm1_unc <- ssm1_unc*area(ssm_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(ssm1, "sum")/1000000
      sum_un <-cellStats(ssm1_unc, "sum")/1000000 -sum 
     
      
      stats3 <- data.frame(product ='SSM1',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)
      
 #Final SSM2
      ssm2_unc <- ssm2+ ssm2*(ssm_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(ssm2, "mean")
      mean_un <-cellStats(ssm2_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      ssm2 <- ssm2*area(ssm2)*100
      ssm2_unc <- ssm2_unc*area(ssm_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(ssm2, "sum")/1000000
      sum_un <-cellStats(ssm2_unc, "sum")/1000000 -sum 
     
      
      stats4 <- data.frame(product ='SSM2',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)
      
 #Final SSM3
      ssm3_unc <- ssm3+ ssm3*(ssm_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(ssm3, "mean")
      mean_un <-cellStats(ssm3_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      ssm3 <- ssm3*area(ssm3)*100
      ssm3_unc <- ssm3_unc*area(ssm3_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(ssm3, "sum")/1000000
      sum_un <-cellStats(ssm3_unc, "sum")/1000000 -sum 
     
      
      stats5 <- data.frame(product ='SSM3',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)

data <- rbind(stats,stats2,stats3,stats4,stats5) 
data[,2:5] <-round(data[,2:5],1)

data$absdiff  <- data[2,4] - data[1,4]
data[3,6] <-    data[3,4] - data[1,4] 
data[4,6] <-    data[4,4] - data[1,4] 
data[5,6] <-    data[5,4] - data[1,4] 
data$absdiff <-round(data$absdiff,2)
data[1,6] <-   ' '

data$reldiff  <- data[3,4] - data[2,4]
data[4,7] <-    data[4,4] - data[2,4] 
data[5,7] <-    data[5,4] - data[2,4] 
data$reldiff <-round(data$reldiff,2)
data[2,7] <-    ' '
data[1,7] <-    ' ' 



data$year <- c(2020,2040,2040,2040,2040)
data <- data[,c("product",'year',"mean","mun","sum", "sun", 'absdiff','reldiff')]
```

```{r echo=FALSE}
dfUnits1 <- c("", "" ,"$t$ $C$ $ha^{-1}$","± $t$ $C$ $ha^{-1}$","Mt C","± Mt C")
colNames <- c("Layer",'Year',"mean"," ","sum", " " )
kable(booktabs= TRUE,data[, 1:6],
      caption = 'Summary of estimates of topsoil SOC stocks in Mt and average SOC content in t $ha^{-1}$ over four scenarios (SSM1-3: Sustainable Soil Management; BAU: Business as Usual) and at the beginning of the simulation at time T0 (2020).',col.names = dfUnits1, align = "c", digits = 3,
      format = 'latex', escape = FALSE) %>%
  add_header_above(header = colNames,  align = "c")%>%
 kable_styling(font_size = 8, latex_options = c("HOLD_position"))
```

```{r echo=FALSE}
dfUnits1 <- c("","Mt C","Mt C")
dfUnits2 <- c("","[final SOC - t0 SOC]","[final SSM SOC - final BAU SOC]")
colNames <- c("Layer",'Absolute difference', 'Relative difference')
dati<-data[2:5, c(1,7:8)]
rownames(dati) <- NULL
kable(booktabs= TRUE,dati,
      caption = 'Absolute and Relative differences in SOC stocks (Mt C)',col.names = dfUnits1, align = "c", digits = 3,
      format = 'latex', escape = FALSE) %>%
   add_header_above(header = dfUnits2,  align = "c")%>%
  add_header_above(header = colNames,  align = "c")%>%
 kable_styling(font_size = 8, latex_options = c("HOLD_position"))
```


```{r, echo =FALSE}


#Relative Sequestration Rates
rsr1 <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM1_Map030.tif'))
rsr1 <- crop(rsr1,map)
rsr1 <- mask(rsr1,map)

rsr2 <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM2_Map030.tif'))
rsr2 <- crop(rsr2,map)
rsr2 <- mask(rsr2,map)

rsr3 <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM3_Map030.tif'))
rsr3 <- crop(rsr3,map)
rsr3 <- mask(rsr3,map)

#Relative Sequestration Rates uncertainty
rsr1_unc <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM1__UncertaintyMap030.tif'))
rsr1_unc <- crop(rsr1_unc,map)
rsr1_unc <- mask(rsr1_unc,map)

rsr2_unc <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM2__UncertaintyMap030.tif'))
rsr2_unc <- crop(rsr2_unc,map)
rsr2_unc <- mask(rsr2_unc,map)

rsr3_unc <- raster(paste0(gseq_folder,'/GSOCseq_RSR_SSM3__UncertaintyMap030.tif'))
rsr3_unc <- crop(rsr3_unc,map)
rsr3_unc <- mask(rsr3_unc,map)

#RSR SSM1
      rsr1_unc <- rsr1+ rsr1*(rsr1_unc/100)
      #Calculate mean no area correction needed
      mean <-cellStats(rsr1, "mean")
      mean_un <-cellStats(rsr1_unc, "mean") -mean             
               
      
      #correct pixel area and ha to km2
      rsr1_a <- rsr1*area(rsr1)*100
      rsr1_unc <- rsr1_unc*area(rsr1_unc)*100
      # Sum over every pixel to get total sequestration potential in Mt
      sum <- cellStats(rsr1_a, "sum")/1000000
      sum_un <-cellStats(rsr1_unc, "sum")/1000000-sum 
     
      
      stats <- data.frame(product ='SSM1',mean=mean, mun=mean_un ,sum=sum,
                          sun=sum_un)
#RSR SSM2
  rsr2_unc <- rsr2+ rsr2*(rsr2_unc/100)
#Calculate mean no area correction needed
mean <-cellStats(rsr2, "mean")
mean_un <-cellStats(rsr2_unc, "mean") -mean             


#correct pixel area and ha to km2
rsr2_a <- rsr2*area(rsr2)*100
rsr2_unc <- rsr2_unc*area(rsr2_unc)*100
# Sum over every pixel to get total sequestration potential in Mt
sum <- cellStats(rsr2_a, "sum")/1000000
sum_un <-cellStats(rsr2_unc, "sum")/1000000-sum 


stats2 <- data.frame(product ='SSM2',mean=mean, mun=mean_un ,sum=sum,
                    sun=sum_un)  

#RSR SSM2
rsr3_unc <- rsr3+ rsr3*(rsr3_unc/100)
#Calculate mean no area correction needed
mean <-cellStats(rsr3, "mean")
mean_un <-cellStats(rsr3_unc, "mean") -mean             


#correct pixel area and ha to km2
rsr3_a <- rsr3*area(rsr3)*100
rsr3_unc <- rsr3_unc*area(rsr3_unc)*100
# Sum over every pixel to get total sequestration potential in Mt
sum <- cellStats(rsr3_a, "sum")/1000000
sum_un <-cellStats(rsr3_unc, "sum")/1000000-sum 


stats3 <- data.frame(product ='SSM3',mean=mean, mun=mean_un ,sum=sum,
                    sun=sum_un) 
 data_rsr <- rbind(stats,stats2,stats3)      
      


 
 
```

```{r, echo=FALSE, fig.cap = paste0("Relative Sequestration Rates in t C ha^-1^ yr^-1^ for the three SSM scenarios for ",country, '.'), fig.width=2.5, fig.height=3, message= FALSE,fig.pos = 'H'}

label <- data.frame(lab=paste(round(data_rsr$sum,2), '\nMt C/yr'), 
                    y=data_rsr$sum + 2*data_rsr[data_rsr$product=='SSM3', 'sun'], x= c('SSM1','SSM2','SSM3'))

ggplot(data_rsr, aes(fill=product,x=product, y=sum)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=sum-sun, ymax=sum+sun), width=.2,position=position_dodge(.9))+
  geom_text(data= label, aes(x=x,y=y, label=lab, color=x ), size=2.5,inherit.aes = F)+
  scale_y_continuous(expand = c(0, 0),limits=c(0,max(data_rsr$sum)+ 3*max(data_rsr$sun)))+
  theme_classic()+
  scale_fill_manual('',values=cols)+
   scale_color_manual('',values=cols)+
      theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_text(size=8,color = "grey40"),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8))+
  ylab("SOC Sequestration Potential "~Mt~C~yr^-1)
```




```{r, echo =FALSE, fig.cap = "Relative Sequestration Rates in t C ha^-1^ yr^-1^.", fig.width=6, fig.height=6, message= FALSE,fig.pos = 'H'}

############Figure 1 RSR #######################################################################
# #Load RSR layers
# 
# 
# if (file.exists(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_RSR_SSM1_Map030_Corr_1km_t0mask_incmask.tif")))
# {rsr1 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_RSR_SSM1_Map030_Corr_1km_t0mask_incmask.tif"))
# rsr2 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_RSR_SSM2_Map030_Corr_1km_t0mask_incmask.tif"))
# rsr3 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_RSR_SSM3_Map030_Corr_1km_t0mask_incmask.tif"))}else{
# rsr1 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_RSR_SSM1_Map030.tif"))
# rsr2 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_RSR_SSM2_Map030.tif"))
# rsr3 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_RSR_SSM3_Map030.tif"))}
# 
# 
# 
rsr1[rsr1==-999] <- NA
rsr2[rsr2==-999] <- NA
rsr3[rsr3==-999] <- NA
 s <- stack(rsr1,rsr2,rsr3)



xl <-expression(t~C~ha^-1~y^-1)
par(bg=NA)
fig <-levelplot(s, 
          layout=c(2, 2),
          margin=FALSE,                       
          colorkey=list(
            space='bottom',                   
            labels=list(my.brks_rsr, font=1),
            axis.line=list(col='black'),
            width=0.7
          ),    
          maxpixels = 2e5,
          par.settings=list(panel.background=list(col="white"),
                            strip.border=list(col='transparent'),
                            strip.background=list(col='white'),
                            axis.line=list(col='transparent')
          ),
          
          scales=list(draw=FALSE),
          xlab=list(xl, cex=0.9,vjust = 0.07), ylab=NULL, 
          col.regions=viridis,                   
          at=c(my.brks_rsr),
          names.attr=c("SSM1", "SSM2", "SSM3"), cex=0.4)+        
  latticeExtra::layer(sp.polygons(map, col='transparent', fill ="grey50"), under = TRUE) 

fig
```



```{r, echo = FALSE, fig.cap = "Absolute differences in SOC stocks in t C ha^-1^ for the year 2040.",fig.width=6, fig.height=6,fig.pos = 'H'}
#Load AbsDiff layers


# 
# if (file.exists(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_AbsDiff_BAU_Map030_Corr_1km_t0mask_incmask.tif")))
#   
# {
# absdiffbau <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_AbsDiff_BAU_Map030_Corr_1km_t0mask_incmask.tif"))
# 
# absdiff1 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_AbsDiff_SMM1_Map030_Corr_1km_t0mask_incmask.tif"))
# absdiff2 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_AbsDiff_SMM2_Map030_Corr_1km_t0mask_incmask.tif"))
# absdiff3 <- raster(paste0("GAP_FILLING/",i, "/",i,"_GSOCseq_AbsDiff_SSM3_Map030_Corr_1km_t0mask_incmask.tif"))
# }else{
# absdiffbau <- raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_AbsDiff_BAU_Map030.tif"))  
# absdiff1 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_AbsDiff_SSM1_Map030.tif"))
# absdiff2 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_AbsDiff_SSM2_Map030.tif"))
# absdiff3 <-raster(paste0("Joint Maps/",i, "/",i,"_GSOCseq_AbsDiff_SSM3_Map030.tif"))
# }


absdiffbau[absdiffbau==-999] <- NA
absdiff2[absdiff2==-999] <- NA
absdiff3[absdiff3==-999] <- NA
absdiff1[absdiff1==-999] <- NA


s <- stack(absdiffbau,absdiff1,absdiff2,absdiff3)


xl <-expression(t~C~ha^-1)
par(bg=NA)
fig <-levelplot(s, 
                layout=c(2, 2),
                margin=FALSE,                       
                colorkey=list(
                  space='bottom',                   
                  labels=list(my.brks_abs, font=1),
                  axis.line=list(col='black'),
                  width=0.7
                ),    
                maxpixels = 2e5,
                par.settings=list(panel.background=list(col="white"),
                                  strip.border=list(col='transparent'),
                                  strip.background=list(col='white'),
                                  axis.line=list(col='transparent')
                ),
                
                  scales=list(draw=FALSE),
          xlab=list(xl, cex=0.9,vjust = 0.07), ylab=NULL, 
          col.regions=viridis,                   
          at=my.brks_abs,
          names.attr=c("BAU","SSM1", "SSM2", "SSM3"), cex=0.4)+      
  latticeExtra::layer(sp.polygons(map, col='transparent', fill ="grey50"), under = TRUE) 

fig
```



```{r, echo=FALSE,fig.width=3, fig.height=3.5, fig.cap = 'Relative Sequestration Rates in t C ha^-1^ yr^-1^ over three diffeent Sustainable Soil Management Scenarios.' ,fig.pos = 'H'}
# #++++++++++++++++++++++++++++++++++++#
# #                                    # 
# # Country Report Results Section     #
# # Boxplots                           #
# #                                    #
# #++++++++++++++++++++++++++++++++++++#
# 
# # Combine all layers into a brick and turn into data.frame
# data <- brick(rsr1,rsr2,rsr3)
# data <- as.data.frame(data)
# 
# #Change the column names, makes ure they follow the same order of how 
# # you bricked them
# cn <- c("SSM1", "SSM2", "SSM3")
# colnames(data) <-cn
# 
# 
# #Remove NAs and round results
# data <- data[complete.cases(data),]
# data[,1:3] <- round(data[,1:3],4)
# data <- setDT(data)
# 
# data = melt(data,
#             measure.vars = c("SSM1", "SSM2", "SSM3"))
# colnames(data)[1] <- "Scenario"
# colnames(data)[2] <- "RSR"
# 
# #################
# #               #
# # Figure 1      #
# # Boxplots       #
# #               #
# #################
# 
# # grouped boxplot
# p <-ggplot(data, aes(x=data$Scenario, y=RSR)) + 
#   stat_boxplot(geom= 'errorbar' , width = 0.3, position = 
#                  position_dodge(width = 0.75) )+
#   geom_boxplot(outlier.shape = NA)+
#   ylim(0,max(data$RSR)+0.01)+
#   ylab("[t/ha yr]") +
#   theme_classic()+
#   theme(axis.title.x=element_blank(),
#         legend.position="bottom")
#   
# p  
# 
# 

```





```{r, echo = FALSE, fig.cap = paste0('Potential Mitigation of Total Agricultural Emissions from the GSOCseq v1.1 improved management scenarios for ', country,'.'),fig.pos = 'H'}
library(webshot)

  # Create the input dataframe
  x= list("Total Agr. emissions", "SSM1", "SSM2", "SSM3", "Final emissions")
  measure= c("relative", "relative", "relative", "relative", "total")
  
  ## Calculate final emissions [tot agr. em - CO2 eq seq under SSM3]
  final <- round(totagrem - totssm3,2)
  
  ## Calculate additional CO2 seq for every scenario
  change_ssm1 <- round(totssm1,2)
  change_ssm2 <- round(totssm2 -totssm1,2)
  change_ssm3 <- round(totssm3 -totssm2,2)
  
  ##Create labels
  text= c(paste0(totagrem),
          paste0( SSM1, " %"),
          paste0(SSM2, " %"),
          paste0( SSM3, " %"),
          paste0(final ))
  
  y= c(totagrem, -change_ssm1 , -change_ssm2, -change_ssm3,0)
  
  ##Create final data frame for plotly
  data = data.frame(x=factor(x,levels=x),measure,text,y)
  
  
  fig <-plot_ly(
    data, name = "20", type = "waterfall", measure = ~measure,
    decreasing = list(marker = list(color = "Green")),
    increasing = (marker = list(color = "orange")),
    totals = list(marker = list(color = "orange")),
    x = ~x, textposition = "outside", y= ~y, text =~text,
    textfont = list( size = 20),
    connector = list(line = list(color= "rgb(63, 63, 63)")),
     width = 700, height = 700) %>%
    config(displayModeBar = FALSE) %>%
    layout(paper_bgcolor= 'white',plot_bgcolor='white',xaxis = list(title = "", titlefont = list(size = 20), tickfont = list(size = 20)),
           yaxis = list(title = "CO<sub>2</sub>-eq Mt yr<sup>-1</sup> ",
                        titlefont = list(size = 20), tickfont = list(size = 20)),
           autosize = TRUE,
           showlegend = FALSE)%>%
    layout(paper_bgcolor= 'white',plot_bgcolor='white') %>%
    layout(paper_bgcolor= 'white',plot_bgcolor='white',
           shapes = list(
             list(type = "rect",
                  fillcolor = "red", line = list(color = "red"), opacity = 1,
                  x0 = -0.4, x1 = 0.4, xref = "x",
                  y0 = 0.0, y1 = totagrem, yref = "y")))
  
htmlwidgets::saveWidget(widget = fig, file = "hc.html")
webshot(url = "hc.html", file = "hc.png", delay = 1, zoom = 4, vheight = 500)
```


# References {-}
**Brendan P. Malone**, **Alex B. McBratney**, **Budiman Minasny**, **Ichsani Wheeler**, A general method for downscaling earth resource information, Computers & Geosciences, Volume 41, 2012, Pages 119-125, ISSN 0098-3004,
https://doi.org/10.1016/j.cageo.2011.08.021.

**FAO**. 2020. Technical specifications and country guidelines for Global Soil Organic Carbon
Sequestration Potential Map (GSOCseq). Rome